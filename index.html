<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mi Diario Salud (Cloud)</title>
<meta name="color-scheme" content="light dark">
<style>
/* --- Estilos similares a los anteriores --- */
:root{
  --bg:#f6f7fb; --card:#ffffff; --ink:#1f2937; --muted:#6b7280; --ring:#e5e7eb;
  --yellow:#fde047; --green:#86efac; --blue:#93c5fd; --purple:#e9d5ff;
}
body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial; background:var(--bg); color:var(--ink);}
header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--ring);padding:10px 12px;display:flex;align-items:center;gap:12px;}
.brand{font-weight:700;}
.spacer{flex:1;}
.btn{border:0;border-radius:12px;padding:10px 14px;background:#111827;color:#fff;cursor:pointer;}
.btn.secondary{background:#374151;}
.btn.ghost{background:transparent;color:var(--ink);}
.card{background:var(--card);border:1px solid var(--ring);border-radius:18px;padding:16px;margin-bottom:16px;}
.palette{display:flex;gap:10px;margin-bottom:10px;}
.sw{width:36px;height:36px;border-radius:50%;border:2px solid #1112;cursor:pointer;position:relative;}
.sw[data-active="true"]::after{content:"";position:absolute;inset:8px;border-radius:50%;border:2px solid #0008;}
.sw[title*="Amarillo"]{background:var(--yellow);}
.sw[title*="Verde"]{background:var(--green);}
.sw[title*="Azul"]{background:var(--blue);}
.sw[title*="Lila"]{background:var(--purple);}
textarea{width:100%;min-height:120px;padding:14px 16px;border-radius:14px;border:1px solid var(--ring);font-size:16px;resize:vertical;}
.list{margin-top:18px;}
.item{border-left:10px solid transparent;padding:12px 14px;border-radius:14px;border:1px solid var(--ring);margin-bottom:12px;}
.meta{display:flex;gap:8px;align-items:center;font-size:12px;color:var(--muted);}
.tag{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--ring);}
.filters{padding:12px 16px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
input, select{padding:10px 12px;border-radius:10px;border:1px solid var(--ring);background:transparent;color:var(--ink);}
footer{opacity:.6;font-size:12px;text-align:center;padding:20px;}
</style>
</head>
<body>

<header>
  <div class="brand"> Mi Diario Salud</div>
  <div class="spacer"></div>
  <div id="loginSection">
    <button id="signinBtn" class="btn secondary">Entrar con Google</button>
    <button id="anonBtn" class="btn ghost">Entrar an贸nimo</button>
    <button id="signoutBtn" class="btn" style="display:none">Salir</button>
    <span id="who"></span>
    <img id="avatar" style="width:28px;height:28px;border-radius:50%;display:none"/>
  </div>
</header>

<main class="grid">
  <section class="card">
    <div class="palette">
      <div class="sw" data-color="yellow" data-category="comida" title="Amarillo 路 Comida"></div>
      <div class="sw" data-color="green" data-category="deporte" title="Verde 路 Deporte"></div>
      <div class="sw" data-color="blue" data-category="sintomas_meds" title="Azul 路 S铆ntomas/medicaci贸n"></div>
      <div class="sw" data-color="purple" data-category="sintomas_em" title="Lila 路 S铆ntomas EM"></div>
    </div>
    <textarea id="entry" placeholder="Escribe aqu铆..."></textarea>
    <div style="margin-top:10px;">
      <button id="saveBtn" class="btn">Guardar</button>
      <button id="clearBtn" class="btn ghost">Limpiar</button>
      <select id="pdfColorFilter">
        <option value="">Todos los colores</option>
        <option value="yellow">Amarillo</option>
        <option value="green">Verde</option>
        <option value="blue">Azul</option>
        <option value="purple">Lila</option>
      </select>
      <button id="downloadPdfBtn" class="btn secondary"> PDF</button>
    </div>
  </section>

  <section class="card filters">
    <input id="fromDate" type="date"/>
    <input id="toDate" type="date"/>
    <select id="byCat">
      <option value="">Todas</option>
      <option value="comida">Amarillo</option>
      <option value="deporte">Verde</option>
      <option value="sintomas_meds">Azul</option>
      <option value="sintomas_em">Lila</option>
    </select>
    <input id="q" type="search" placeholder="Buscar..."/>
    <button id="resetFilters" class="btn ghost">Reset</button>
  </section>

  <section class="card list" id="list"></section>
  <footer>Guardado en la nube con Firebase 路 Solo t煤 puedes ver tus registros.</footer>
</main>

<!-- jsPDF UMD -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, signInAnonymously, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, serverTimestamp, query, where, orderBy, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCo9Yp1KX0qksIcrQScIpKOREh8tfKFuLI",
  authDomain: "llibreta210715.firebaseapp.com",
  projectId: "llibreta210715",
  storageBucket: "llibreta210715.appspot.com",
  messagingSenderId: "85382775730",
  appId: "1:85382775730:web:e6bc697d70944b2ef01aab"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const entryEl = document.getElementById('entry');
const listEl = document.getElementById('list');
const saveBtn = document.getElementById('saveBtn');
const clearBtn = document.getElementById('clearBtn');
const downloadPdfBtn = document.getElementById('downloadPdfBtn');
const pdfColorFilter = document.getElementById('pdfColorFilter');

let current={color:'yellow',category:'comida'};
document.querySelectorAll('.sw').forEach(sw=>{
  sw.addEventListener('click',()=>{
    document.querySelectorAll('.sw').forEach(x=>x.dataset.active='false');
    sw.dataset.active='true';
    current.color=sw.dataset.color;
    current.category=sw.dataset.category;
    entryEl.style.borderLeft=`10px solid var(--${current.color})`;
  });
});
document.querySelector('.sw').click();

const signinBtn=document.getElementById('signinBtn');
const anonBtn=document.getElementById('anonBtn');
const signoutBtn=document.getElementById('signoutBtn');
const who=document.getElementById('who');
const avatar=document.getElementById('avatar');
const provider=new GoogleAuthProvider();

signinBtn.onclick=()=>signInWithPopup(auth,provider).catch(e=>alert(e.message));
anonBtn.onclick=()=>signInAnonymously(auth).then(({user})=>{
  if(!user.displayName) updateProfile(user,{displayName:'An贸nimo'});
}).catch(e=>alert(e.message));
signoutBtn.onclick=()=>signOut(auth);

let unsub=null;
function stopListening(){if(unsub){unsub();unsub=null;}}
function startListening(uid){
  stopListening();
  const ref=collection(db,'entries');
  const qRef=query(ref,where('uid','==',uid),orderBy('createdAt','desc'));
  unsub=onSnapshot(qRef,snap=>{
    const all=snap.docs.map(d=>({id:d.id,...d.data()}));
    render(all);
  });
}

onAuthStateChanged(auth,user=>{
  if(user){
    signinBtn.style.display='none'; anonBtn.style.display='none'; signoutBtn.style.display='inline-block';
    who.textContent=user.displayName||user.email||'Usuario';
    avatar.src=user.photoURL||''; avatar.style.display='inline-block';
    startListening(user.uid);
  }else{
    who.textContent=''; avatar.style.display='none';
    signinBtn.style.display='inline-block'; anonBtn.style.display='inline-block'; signoutBtn.style.display='none';
    stopListening();
    listEl.innerHTML=`<div class="item">Inicia sesi贸n para ver/guardar tus notas.</div>`;
  }
});

saveBtn.onclick=async()=>{
  const text=entryEl.value.trim(); if(!text){alert('Escribe algo');return;}
  const user=auth.currentUser; if(!user){alert('Inicia sesi贸n'); return;}
  try{ await addDoc(collection(db,'entries'),{uid:user.uid,text,category:current.category,color:current.color,createdAt:serverTimestamp()}); entryEl.value=''; }catch(e){alert(e.message);}
};
clearBtn.onclick=()=>entryEl.value='';

function render(data){
  listEl.innerHTML='';
  if(!data.length){listEl.innerHTML=`<div class="item">No hay notas.</div>`; return;}
  data.forEach(e=>{
    const d=e.createdAt?.toDate?e.createdAt.toDate():new Date();
    const wrap=document.createElement('article');
    wrap.className='item'; wrap.style.borderLeftColor=`var(--${e.color||'yellow'})`;
    wrap.innerHTML=`<div class="meta"><span class="tag">${e.category}</span> 路 <time>${d.toLocaleString()}</time></div>
      <div style="white-space:pre-wrap;margin-top:6px">${e.text}</div>`;
    listEl.appendChild(wrap);
  });
}

// --- PDF ---
downloadPdfBtn.onclick=async()=>{
  const user=auth.currentUser; if(!user){alert('Inicia sesi贸n');return;}
  const colorFilter=pdfColorFilter.value;
  const ref=collection(db,'entries');
  const qRef=query(ref,where('uid','==',user.uid),orderBy('createdAt','desc'));
  const snap=await getDocs(qRef);
  let rows=snap.docs.map(d=>({id:d.id,...d.data()}));
  if(colorFilter) rows=rows.filter(e=>e.color===colorFilter);

  const { jsPDF } = window.jspdf;
  const doc=new jsPDF();
  let y=20;
  const colorMap={yellow:[253,224,71],green:[134,239,172],blue:[147,197,253],purple:[233,213,255]};
  rows.forEach(e=>{
    const c=colorMap[e.color]||[200,200,200];
    doc.setFillColor(...c); doc.rect(10,y-2,190,8,'F'); y+=10;
    const d=e.createdAt?.toDate?e.createdAt.toDate():new Date();
    doc.setTextColor(0,0,0);
    doc.text(`${d.toLocaleString()} [${e.category}]`,12,y); y+=6;
    const lines=doc.splitTextToSize(e.text,180);
    doc.text(lines,12,y); y+=lines.length*6+6;
    if(y>270){doc.addPage(); y=20;}
  });
  doc.save('MiDiario.pdf');
};
</script>
</body>
</html>
