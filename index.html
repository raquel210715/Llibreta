<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mi Diario Salud (Cloud)</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --primary:#4a90e2;
      --yellow:#fff9c4; --green:#c8e6c9; --blue:#bbdefb; --purple:#e1bee7;
    }
    body{font-family:sans-serif;margin:0;background:var(--bg);color:#333;}
    header{display:flex;justify-content:space-between;align-items:center;
      padding:10px 16px;background:var(--primary);color:white;}
    header h1{font-size:18px;margin:0;}
    #user-info{display:flex;align-items:center;gap:8px;}
    .avatar{width:28px;height:28px;border-radius:50%;object-fit:cover;}
    main{max-width:800px;margin:0 auto;padding:16px;}
    textarea{width:100%;min-height:80px;padding:8px;}
    select,button,input[type=date]{padding:6px;margin:4px;}
    .entry{background:var(--card);padding:8px;margin:8px 0;border-radius:8px;}
    .yellow{background:var(--yellow);} .green{background:var(--green);}
    .blue{background:var(--blue);} .purple{background:var(--purple);}
    .filters{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0;}
    .actions{margin-top:10px;}
    .entry-header{display:flex;justify-content:space-between;align-items:center;}
  </style>
</head>
<body>
  <header>
    <h1>Mi Diario Salud</h1>
    <div id="user-info">
      <img id="user-pic" class="avatar" src="" alt="" hidden>
      <span id="user-name"></span>
      <button id="login">Iniciar sesi√≥n</button>
      <button id="logout" hidden>Salir</button>
    </div>
  </header>
  <main>
    <section>
      <textarea id="text" placeholder="Escribe aqu√≠..."></textarea><br/>
      <select id="category">
        <option value="yellow">√Ånimo</option>
        <option value="green">Salud</option>
        <option value="blue">Ejercicio</option>
        <option value="purple">Otro</option>
      </select>
      <button id="save">Guardar</button>
    </section>

    <section class="filters">
      <label>Desde <input type="date" id="fromDate"></label>
      <label>Hasta <input type="date" id="toDate"></label>
      <select id="byCategory">
        <option value="">Todas las categor√≠as</option>
        <option value="yellow">√Ånimo</option>
        <option value="green">Salud</option>
        <option value="blue">Ejercicio</option>
        <option value="purple">Otro</option>
      </select>
      <input type="text" id="searchText" placeholder="Buscar texto">
      <button id="applyFilters">Aplicar filtros</button>
    </section>

    <section class="actions">
      <button id="downloadTxt">Descargar TXT</button>
      <button id="downloadPdf">Descargar PDF</button>
    </section>

    <section id="entries"></section>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyXXXXXXX",
    authDomain: "XXXX.firebaseapp.com",
    projectId: "XXXX",
    storageBucket: "XXXX.appspot.com",
    messagingSenderId: "XXXX",
    appId: "XXXX"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const loginBtn=document.getElementById('login');
  const logoutBtn=document.getElementById('logout');
  const userPic=document.getElementById('user-pic');
  const userName=document.getElementById('user-name');

  loginBtn.onclick=()=>{ 
    const provider=new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider);
  };
  logoutBtn.onclick=()=>auth.signOut();

  auth.onAuthStateChanged(user=>{
    if(user){
      userPic.src=user.photoURL; userPic.hidden=false;
      userName.textContent=user.displayName;
      loginBtn.hidden=true; logoutBtn.hidden=false;
      loadEntries();
    }else{
      userPic.hidden=true; userName.textContent='';
      loginBtn.hidden=false; logoutBtn.hidden=true;
      document.getElementById('entries').innerHTML='';
    }
  });

  document.getElementById('save').onclick=async ()=>{
    const text=document.getElementById('text').value;
    const category=document.getElementById('category').value;
    const user=auth.currentUser;
    if(!user||!text) return;
    await db.collection('entries').add({
      uid:user.uid, text, category, color:category,
      createdAt:firebase.firestore.FieldValue.serverTimestamp()
    });
    document.getElementById('text').value='';
    loadEntries();
  };

  async function loadEntries(){
    const user=auth.currentUser; if(!user) return;
    const snap=await db.collection('entries').where('uid','==',user.uid).orderBy('createdAt','desc').get();
    const arr=snap.docs.map(d=>({id:d.id,...d.data()}));
    renderEntries(arr);
  }

  function renderEntries(entries){
    const cont=document.getElementById('entries');
    cont.innerHTML='';
    const filtered=applyFilters(entries);
    filtered.forEach(e=>{
      const div=document.createElement('div');
      div.className='entry '+e.category;
      const date=e.createdAt?.toDate?e.createdAt.toDate():new Date();
      div.innerHTML=`
        <div class="entry-header">
          <small>${date.toLocaleString()} - ${labelFromCat(e.category)}</small>
          <button onclick="deleteEntry('${e.id}')">üóë</button>
        </div>
        <div>${e.text}</div>`;
      cont.appendChild(div);
    });
  }

  async function deleteEntry(id){
    if(confirm("¬øEliminar entrada?")){
      await db.collection('entries').doc(id).delete();
      loadEntries();
    }
  }

  function labelFromCat(c){
    return {yellow:'√Ånimo',green:'Salud',blue:'Ejercicio',purple:'Otro'}[c]||c;
  }

  // === FILTROS ===
  function applyFilters(entries){
    const from=document.getElementById('fromDate').value;
    const to=document.getElementById('toDate').value;
    const cat=document.getElementById('byCategory').value;
    const text=document.getElementById('searchText').value.toLowerCase();
    return entries.filter(e=>{
      const d=e.createdAt?.toDate?e.createdAt.toDate():new Date();
      if(from && d<new Date(from)) return false;
      if(to && d>new Date(to+'T23:59')) return false;
      if(cat && e.category!==cat) return false;
      if(text && !e.text.toLowerCase().includes(text)) return false;
      return true;
    });
  }
  document.getElementById('applyFilters').onclick=loadEntries;

  // === DESCARGAS ===
  document.getElementById('downloadTxt').onclick=async ()=>{
    const user=auth.currentUser; if(!user) return;
    const snap=await db.collection('entries').where('uid','==',user.uid).orderBy('createdAt','desc').get();
    const arr=snap.docs.map(d=>({id:d.id,...d.data()}));
    const rows=applyFilters(arr);
    const lines=rows.map(e=>{
      const d=e.createdAt?.toDate?e.createdAt.toDate():new Date();
      return `[${d.toLocaleString()}] (${labelFromCat(e.category)})\n${e.text}\n`;
    });
    const blob=new Blob([lines.join('\n')],{type:'text/plain'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob); a.download='mi_diario_salud.txt';
    a.click(); URL.revokeObjectURL(a.href);
  };

  document.getElementById('downloadPdf').onclick=async ()=>{
    const { jsPDF } = window.jspdf;
    const doc=new jsPDF();
    let y=10;
    const user=auth.currentUser; if(!user) return;
    const snap=await db.collection('entries').where('uid','==',user.uid).orderBy('createdAt','desc').get();
    const arr=snap.docs.map(d=>({id:d.id,...d.data()}));
    const rows=applyFilters(arr);

    for(const e of rows){
      const d=e.createdAt?.toDate?e.createdAt.toDate():new Date();
      const color=colorHexToRGB(e.color);
      doc.setTextColor(...color);
      doc.text(`[${d.toLocaleString()}] (${labelFromCat(e.category)})`,12,y);
      y+=8;
      const split=doc.splitTextToSize(e.text,180);
      doc.text(split,12,y);
      y+=split.length*8+6;
      if(y>270){doc.addPage();y=10;}
    }
    doc.save('mi_diario_salud.pdf');
  };

  function colorHexToRGB(c){
    const map={yellow:[247,202,24],green:[76,175,80],blue:[33,150,243],purple:[156,39,176]};
    return map[c]||[0,0,0];
  }
  </script>
</body>
</html>
