<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mi Diario Salud (Cloud)</title>
<meta name="color-scheme" content="light dark" />
<style>
:root{
  --bg:#f6f7fb; --card:#ffffff; --ink:#1f2937; --muted:#6b7280; --ring:#e5e7eb;
  --yellow:#fde047; --green:#86efac; --blue:#93c5fd; --purple:#e9d5ff;
}
@media (prefers-color-scheme: dark){
  :root{ --bg:#0b1020; --card:#111827; --ink:#f3f4f6; --muted:#9ca3af; --ring:#1f2937; }
}
*{box-sizing:border-box}
body{margin:0;font-family:ui-sans-serif,system-ui,sans-serif;background:var(--bg);color:var(--ink);}
header{position:sticky;top:0;z-index:10;background:var(--card);border-bottom:1px solid var(--ring);padding:10px 12px;display:flex;align-items:center;gap:12px;}
.brand{font-weight:700;}
.spacer{flex:1}
.btn{border:0;border-radius:12px;padding:10px 14px;background:#111827;color:#fff;cursor:pointer;font-weight:600;box-shadow:0 4px 12px rgba(0,0,0,.08)}
.btn.secondary{background:#374151}
.btn.ghost{background:transparent;color:var(--ink)}
.btn.icon{width:44px;height:44px;display:grid;place-items:center;border-radius:50%}
.grid{max-width:960px;margin:20px auto;padding:0 14px}
.card{background:var(--card);border:1px solid var(--ring);border-radius:18px;box-shadow:0 8px 30px rgba(2,8,20,0.05);}
.composer{padding:16px}
.row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
textarea{width:100%;min-height:120px;resize:vertical;padding:14px 16px;border-radius:14px;border:1px solid var(--ring);outline:none;font-size:16px;background:transparent}
.palette{display:flex;gap:10px}
.sw{width:36px;height:36px;border-radius:50%;border:2px solid #1112;cursor:pointer;position:relative}
.sw[data-active="true"]::after{content:"";position:absolute;inset:8px;border-radius:50%;border:2px solid #0008}
.sw[title*="Amarillo"]{background:var(--yellow)}
.sw[title*="Verde"]{background:var(--green)}
.sw[title*="Azul"]{background:var(--blue)}
.sw[title*="Lila"]{background:var(--purple)}
.actions{display:flex;gap:10px;justify-content:flex-end;padding:10px 0}
.list{margin-top:18px;padding:8px}
.item{border-left:10px solid transparent;padding:12px 14px;border-radius:14px;border:1px solid var(--ring);margin-bottom:12px;background:var(--card);cursor:pointer}
.meta{display:flex;gap:8px;align-items:center;font-size:12px;color:var(--muted)}
.tag{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--ring);}
.filters{padding:12px 16px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
input[type="date"]{padding:10px 12px;border-radius:10px;border:1px solid var(--ring);background:transparent;color:var(--ink)}
.search{flex:1;min-width:180px}
.login{display:flex;align-items:center;gap:10px}
.avatar{width:28px;height:28px;border-radius:50%;background:#0002}
footer{opacity:.6;font-size:12px;text-align:center;padding:20px}
</style>
</head>
<body>
<header>
  <div class="brand"> Mi Diario Salud</div>
  <div class="spacer"></div>
  <div class="login">
    <img id="avatar" class="avatar" alt="" />
    <span id="who" class="muted"></span>
    <button id="signinBtn" class="btn secondary">Entrar con Google</button>
    <button id="anonBtn" class="btn ghost">Entrar an贸nimo</button>
    <button id="signoutBtn" class="btn" style="display:none">Salir</button>
  </div>
</header>
<main class="grid">
<section class="card composer">
  <div class="row" style="justify-content:space-between">
    <div class="palette" role="group" aria-label="Categor铆as">
      <div class="sw" id="sw-yellow" title="Amarillo 路 Comida" data-color="yellow" data-category="comida"></div>
      <div class="sw" id="sw-green" title="Verde 路 Deporte" data-color="green" data-category="deporte"></div>
      <div class="sw" id="sw-blue" title="Azul 路 S铆ntomas/medicaci贸n" data-color="blue" data-category="sintomas_meds"></div>
      <div class="sw" id="sw-purple" title="Lila 路 S铆ntomas EM" data-color="purple" data-category="sintomas_em"></div>
    </div>
    <div class="row">
      <button id="downloadBtn" class="btn secondary">Descargar</button>
      <button id="openAllBtn" class="btn icon"></button>
    </div>
  </div>
  <textarea id="entry" placeholder="Escribe aqu铆... (se guardar谩 con fecha y color)"></textarea>
  <div class="actions">
    <button id="saveBtn" class="btn">Guardar</button>
    <button id="clearBtn" class="btn ghost">Limpiar</button>
  </div>
</section>

<section class="card filters">
  <input id="fromDate" type="date" />
  <input id="toDate" type="date" />
  <select id="byCat">
    <option value="">Todas las categor铆as</option>
    <option value="comida">Amarillo 路 Comida</option>
    <option value="deporte">Verde 路 Deporte</option>
    <option value="sintomas_meds">Azul 路 S铆ntomas/medicaci贸n</option>
    <option value="sintomas_em">Lila 路 S铆ntomas EM</option>
  </select>
  <input id="q" class="search" type="search" placeholder="Buscar texto..." />
  <button id="resetFilters" class="btn ghost">Reset</button>
</section>

<section class="card list" id="list" aria-live="polite"></section>
<footer>Guardado en la nube con Firebase 路 Funciona offline y sincroniza cuando vuelves a tener conexi贸n.</footer>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, signInAnonymously, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, setDoc, serverTimestamp, query, where, orderBy, onSnapshot, enableIndexedDbPersistence, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCo9Yp1KX0qksIcrQScIpKOREh8tfKFuLI",
  authDomain: "llibreta210715.firebaseapp.com",
  projectId: "llibreta210715",
  storageBucket: "llibreta210715.firebasestorage.app",
  messagingSenderId: "85382775730",
  appId: "1:85382775730:web:e6bc697d70944b2ef01aab"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
enableIndexedDbPersistence(db).catch(()=>{});

const entryEl=document.getElementById('entry');
const listEl=document.getElementById('list');
const saveBtn=document.getElementById('saveBtn');
const clearBtn=document.getElementById('clearBtn');
const downloadBtn=document.getElementById('downloadBtn');
const fromDateEl=document.getElementById('fromDate');
const toDateEl=document.getElementById('toDate');
const byCatEl=document.getElementById('byCat');
const qEl=document.getElementById('q');
const resetFilters=document.getElementById('resetFilters');
const openAllBtn=document.getElementById('openAllBtn');
const pal=Array.from(document.querySelectorAll('.sw'));
let current={color:'yellow',category:'comida'};
let unsub=null;
let editingId=null;
let allEntries=[];

pal.forEach(sw=>{
  sw.addEventListener('click',()=>{
    pal.forEach(x=>x.dataset.active='false');
    sw.dataset.active='true';
    current.color=sw.dataset.color;
    current.category=sw.dataset.category;
    entryEl.style.borderLeft=`10px solid var(--${current.color})`;
  });
});
pal[0].click();

const signinBtn=document.getElementById('signinBtn');
const anonBtn=document.getElementById('anonBtn');
const signoutBtn=document.getElementById('signoutBtn');
const who=document.getElementById('who');
const avatar=document.getElementById('avatar');
const provider=new GoogleAuthProvider();

signinBtn.onclick=async()=>{ try{ await signInWithPopup(auth,provider);}catch(e){alert(e.message)}};
anonBtn.onclick=async()=>{ try{ const {user}=await signInAnonymously(auth); if(!user.displayName){await updateProfile(user,{displayName:'An贸nimo'})}}catch(e){alert(e.message)}};
signoutBtn.onclick=()=>signOut(auth);

onAuthStateChanged(auth,(user)=>{
  if(user){
    signinBtn.style.display='none'; anonBtn.style.display='none'; signoutBtn.style.display='inline-block';
    who.textContent=user.displayName||user.email||'Usuario';
    avatar.src=user.photoURL||'';
    startListening(user.uid);
  }else{
    who.textContent=''; avatar.removeAttribute('src'); signinBtn.style.display='inline-block'; anonBtn.style.display='inline-block'; signoutBtn.style.display='none';
    stopListening(); listEl.innerHTML=`<div class="item" style="border-left-color:var(--blue)">Inicia sesi贸n para ver/guardar tus notas en la nube.</div>`;
  }
});

function stopListening(){if(unsub){unsub(); unsub=null;}}

function startListening(uid){
  stopListening();
  const ref=collection(db,'entries');
  const qRef=query(ref,where('uid','==',uid),orderBy('createdAt','desc'));
  unsub=onSnapshot(qRef,(snap)=>{
    allEntries=snap.docs.map(d=>({id:d.id,...d.data()}));
    render(allEntries);
  });
}

saveBtn.onclick=async()=>{
  const text=entryEl.value.trim(); if(!text){alert('Escribe algo antes de guardar');return;}
  const user=auth.currentUser; if(!user){alert('Inicia sesi贸n primero');return;}
  try{
    if(editingId){
      await setDoc(doc(db,'entries',editingId),{
        uid:user.uid,text,category:current.category,color:current.color,createdAt:serverTimestamp()
      },{merge:true});
      editingId=null;
    }else{
      await addDoc(collection(db,'entries'),{
        uid:user.uid,text,category:current.category,color:current.color,createdAt:serverTimestamp()
      });
    }
    entryEl.value=''; render(allEntries);
  }catch(e){alert('Error al guardar: '+e.message);}
};

clearBtn.onclick=()=>{ entryEl.value=''; editingId=null; };

function render(data){
  const filt=applyFilters(data);
  listEl.innerHTML='';
  if(!filt.length){ listEl.innerHTML=`<div class="item" style="border-left-color:var(--purple)">No hay notas para los filtros actuales.</div>`; return;}
  for(const e of filt){
    const date=toLocal(e.createdAt);
    const wrap=document.createElement('article');
    wrap.className='item'; wrap.style.borderLeftColor=`var(--${e.color||'yellow'})`;
    wrap.innerHTML=`
      <div class="meta">
        <span class="tag">${labelFromCat(e.category)}</span>
        <span>路</span>
        <time datetime="${date.iso}">${date.pretty}</time>
      </div>
      <div style="white-space:pre-wrap; margin-top:6px">${escapeHtml(e.text)}</div>
    `;
    wrap.onclick=()=>{ entryEl.value=e.text; editingId=e.id; current.color=e.color; current.category=e.category; entryEl.style.borderLeft=`10px solid var(--${current.color})`; };
    listEl.appendChild(wrap);
  }
}

function labelFromCat(c){
  return c==='comida'?'Amarillo 路 Comida':c==='deporte'?'Verde 路 Deporte':c==='sintomas_meds'?'Azul 路 S铆ntomas/medicaci贸n':'Lila 路 S铆ntomas EM';
}

function toLocal(ts){ if(!ts)return{iso:'',pretty:'(sin fecha)'}; const d=ts.toDate?ts.toDate():new Date(ts); return {iso:d.toISOString(),pretty:d.toLocaleString()}; }
function escapeHtml(str){return str.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');}

function applyFilters(list){
  const from = fromDateEl.value ? new Date(fromDateEl.value) : null;
  const to = toDateEl.value ? new Date(toDateEl.value+'T23:59:59') : null;
  const cat = byCatEl.value || '';
  const q = qEl.value.toLowerCase().trim();
  return list.filter(e=>{
    const d = e.createdAt?.toDate ? e.createdAt.toDate() : (e.createdAt ? new Date(e.createdAt) : null);
    if (from && (!d || d<from)) return false;
    if (to && (!d || d>to)) return false;
    if (cat && e.category!==cat) return false;
    if (q && !e.text.toLowerCase().includes(q)) return false;
    return true;
  });
}

[fromDateEl,toDateEl,byCatEl,qEl].forEach(el=>el.addEventListener('input',()=>{ render(allEntries); }));
resetFilters.onclick=()=>{ fromDateEl.value=''; toDateEl.value=''; byCatEl.value=''; qEl.value=''; render(allEntries); };
openAllBtn.onclick=()=>{ window.scrollTo({top: document.querySelector('.filters').offsetTop-80, behavior:'smooth'}); };

downloadBtn.onclick=()=>{
  const user=auth.currentUser; if(!user){alert('Inicia sesi贸n primero');return;}
  const lines=allEntries.map(e=>`[${toLocal(e.createdAt).pretty}] (${labelFromCat(e.category)})\n${e.text}\n`);
  const blob=new Blob([lines.join('\n')],{type:'text/plain'});
  const url=URL.createObjectURL(blob);
  const a=Object.assign(document.createElement('a'),{href:url,download:'mi_diario_salud.txt'});
  a.click(); URL.revokeObjectURL(url);
};
</script>
</body>
</html>
