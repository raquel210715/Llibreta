<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mi Diario Salud (Cloud)</title>
<meta name="color-scheme" content="light dark">
<style>
:root{
  --bg:#f6f7fb; --card:#ffffff; --ink:#1f2937; --muted:#6b7280; --ring:#e5e7eb;
  --yellow:#fde047; --green:#86efac; --blue:#93c5fd; --purple:#e9d5ff;
}
body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial; background:var(--bg); color:var(--ink);}
header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--ring);padding:10px 12px;display:flex;align-items:center;gap:12px;}
.brand{font-weight:700;}
.spacer{flex:1;}
.btn{border:0;border-radius:12px;padding:10px 14px;background:#111827;color:#fff;cursor:pointer;}
.btn.secondary{background:#374151;}
.btn.ghost{background:transparent;color:var(--ink);}
.card{background:var(--card);border:1px solid var(--ring);border-radius:18px;padding:16px;margin-bottom:16px;}
.palette{display:flex;gap:10px;margin-bottom:10px;}
.sw{width:36px;height:36px;border-radius:50%;border:2px solid #1112;cursor:pointer;position:relative;}
.sw[data-active="true"]::after{content:"";position:absolute;inset:8px;border-radius:50%;border:2px solid #0008;}
.sw[title*="Amarillo"]{background:var(--yellow);}
.sw[title*="Verde"]{background:var(--green);}
.sw[title*="Azul"]{background:var(--blue);}
.sw[title*="Lila"]{background:var(--purple);}
textarea{width:100%;min-height:120px;padding:14px 16px;border-radius:14px;border:1px solid var(--ring);font-size:16px;resize:vertical;}
.list{margin-top:18px;}
.item{border-left:10px solid transparent;padding:12px 14px;border-radius:14px;border:1px solid var(--ring);margin-bottom:12px;}
.meta{display:flex;gap:8px;align-items:center;font-size:12px;color:var(--muted);}
.tag{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--ring);}
.filters{padding:12px 16px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
input, select{padding:10px 12px;border-radius:10px;border:1px solid var(--ring);background:transparent;color:var(--ink);}
footer{opacity:.6;font-size:12px;text-align:center;padding:20px;}
</style>
</head>
<body>

<header>
  <div class="brand">📒 Mi Diario Salud</div>
  <div class="spacer"></div>
  <div id="loginSection">
    <button id="signinBtn" class="btn secondary">Entrar con Google</button>
    <button id="anonBtn" class="btn ghost">Entrar anónimo</button>
    <button id="signoutBtn" class="btn" style="display:none">Salir</button>
    <span id="who"></span>
    <img id="avatar" style="width:28px;height:28px;border-radius:50%;display:none"/>
  </div>
</header>

<main class="grid">
  <section class="card">
    <div class="palette">
      <div class="sw" data-color="yellow" data-category="comida" title="Amarillo · Comida"></div>
      <div class="sw" data-color="green" data-category="deporte" title="Verde · Deporte"></div>
      <div class="sw" data-color="blue" data-category="sintomas_meds" title="Azul · Síntomas/medicación"></div>
      <div class="sw" data-color="purple" data-category="sintomas_em" title="Lila · Síntomas EM"></div>
    </div>
    <textarea id="entry" placeholder="Escribe aquí..."></textarea>
    <div style="margin-top:10px;">
      <button id="saveBtn" class="btn">Guardar</button>
      <button id="clearBtn" class="btn ghost">Limpiar</button>
      <select id="pdfColorFilter">
        <option value="">Todos los colores</option>
        <option value="yellow">Amarillo</option>
        <option value="green">Verde</option>
        <option value="blue">Azul</option>
        <option value="purple">Lila</option>
      </select>
      <button id="downloadPdfBtn" class="btn secondary">Descargar PDF</button>
    </div>
  </section>

  <section class="card filters">
    <input id="fromDate" type="date" />
    <input id="toDate" type="date" />
    <select id="byCat">
      <option value="">Todas las categorías</option>
      <option value="comida">Amarillo · Comida</option>
      <option value="deporte">Verde · Deporte</option>
      <option value="sintomas_meds">Azul · Síntomas/medicación</option>
      <option value="sintomas_em">Lila · Síntomas EM</option>
    </select>
    <input id="q" type="search" placeholder="Buscar texto..." />
    <button id="resetFilters" class="btn ghost">Reset</button>
  </section>

  <section class="card list" id="list"></section>
</main>

<footer>Guardado en la nube con Firebase · Funciona offline y sincroniza cuando vuelves a tener conexión.</footer>

<!-- Firebase SDKs -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, signInAnonymously, updateProfile, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, serverTimestamp, query, where, orderBy, onSnapshot, getDocs, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "TU_API_KEY",
  authDomain: "TU_PROJECT.firebaseapp.com",
  projectId: "TU_PROJECT",
  storageBucket: "TU_PROJECT.appspot.com",
  messagingSenderId: "XXX",
  appId: "XXX"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
enableIndexedDbPersistence(db).catch(()=>{});

const entryEl = document.getElementById('entry');
const saveBtn = document.getElementById('saveBtn');
const clearBtn = document.getElementById('clearBtn');
const listEl = document.getElementById('list');
const fromDateEl = document.getElementById('fromDate');
const toDateEl = document.getElementById('toDate');
const byCatEl = document.getElementById('byCat');
const qEl = document.getElementById('q');
const resetFilters = document.getElementById('resetFilters');
const pdfColorFilter = document.getElementById('pdfColorFilter');
const downloadPdfBtn = document.getElementById('downloadPdfBtn');

let current = { color: 'yellow', category: 'comida' };
let unsub = null;
const pal = Array.from(document.querySelectorAll('.sw'));
pal.forEach(sw=>{
  sw.addEventListener('click',()=>{
    pal.forEach(x=>x.dataset.active='false');
    sw.dataset.active='true';
    current.color=sw.dataset.color;
    current.category=sw.dataset.category;
    entryEl.style.borderLeft = `10px solid var(--${current.color})`;
  });
});
pal[0].click();

// Auth
const signinBtn = document.getElementById('signinBtn');
const anonBtn = document.getElementById('anonBtn');
const signoutBtn = document.getElementById('signoutBtn');
const who = document.getElementById('who');
const avatar = document.getElementById('avatar');
const provider = new GoogleAuthProvider();

signinBtn.onclick = async ()=>{ try{ await signInWithPopup(auth,provider);}catch(e){alert(e.message)}};
anonBtn.onclick = async ()=>{ 
  try{
    const { user } = await signInAnonymously(auth);
    if(!user.displayName){await updateProfile(user,{displayName:'Anónimo'});}
  }catch(e){alert(e.message);}
};
signoutBtn.onclick = ()=>signOut(auth);

onAuthStateChanged(auth,user=>{
  if(user){
    signinBtn.style.display='none';
    anonBtn.style.display='none';
    signoutBtn.style.display='inline-block';
    who.textContent=user.displayName||user.email||'Usuario';
    avatar.src=user.photoURL||'';
    avatar.style.display='inline-block';
    startListening(user.uid);
  }else{
    who.textContent='';
    avatar.removeAttribute('src');
    avatar.style.display='none';
    signinBtn.style.display='inline-block';
    anonBtn.style.display='inline-block';
    signoutBtn.style.display='none';
    stopListening();
    listEl.innerHTML='<div class="item" style="border-left-color:var(--blue)">Inicia sesión para ver/guardar tus notas en la nube.</div>';
  }
});

function stopListening(){ if(unsub){unsub(); unsub=null;} }
function startListening(uid){
  stopListening();
  const ref = collection(db,'entries');
  const qRef = query(ref,where('uid','==',uid),orderBy('createdAt','desc'));
  unsub = onSnapshot(qRef,snap=>{
    const all = snap.docs.map(d=>({id:d.id,...d.data()}));
    render(all);
  });
}

saveBtn.onclick = async ()=>{
  const text = entryEl.value.trim();
  if(!text){alert('Escribe algo antes de guardar'); return;}
  const user = auth.currentUser; if(!user){alert('Inicia sesión primero'); return;}
  try{
    await addDoc(collection(db,'entries'),{
      uid:user.uid,
      text,
      category:current.category,
      color:current.color,
      createdAt:serverTimestamp()
    });
    entryEl.value='';
  }catch(e){alert('Error al guardar: '+e.message);}
};
clearBtn.onclick = ()=>entryEl.value='';

function render(data){
  const filt = applyFilters(data);
  listEl.innerHTML='';
  if(!filt.length){ listEl.innerHTML='<div class="item" style="border-left-color:var(--purple)">No hay notas para los filtros actuales.</div>'; return; }
  for(const e of filt){
    const date = e.createdAt?.toDate ? e.createdAt.toDate() : new Date();
    const wrap = document.createElement('article');
    wrap.className='item';
    wrap.style.borderLeftColor = `var(--${e.color||'yellow'})`;
    wrap.innerHTML = `<div class="meta"><span class="tag">${labelFromCat(e.category)}</span><span>·</span><time>${date.toLocaleString()}</time></div><div style="white-space:pre-wrap;margin-top:6px">${escapeHtml(e.text)}</div>`;
    listEl.appendChild(wrap);
  }
}

function labelFromCat(c){return c==='comida'?'Amarillo · Comida':c==='deporte'?'Verde · Deporte':c==='sintomas_meds'?'Azul · Síntomas/medicación':'Lila · Síntomas EM';}
function escapeHtml(str){return str.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');}
function applyFilters(list){
  const from = fromDateEl.value ? new Date(fromDateEl.value) : null;
  const to = toDateEl.value ? new Date(toDateEl.value+'T23:59:59') : null;
  const cat = byCatEl.value || '';
  const q = qEl.value.toLowerCase().trim();
  return list.filter(e=>{
    const d = e.createdAt?.toDate ? e.createdAt.toDate() : new Date();
    if(from && d<from) return false;
    if(to && d>to) return false;
    if(cat && e.category!==cat) return false;
    if(q && !e.text.toLowerCase().includes(q)) return false;
    return true;
  });
}

[fromDateEl,toDateEl,byCatEl,qEl].forEach(el=>el.addEventListener('input',()=>{
  const user = auth.currentUser; if(!user) return;
  const ref = collection(db,'entries');
  const qRef = query(ref,where('uid','==',user.uid),orderBy('createdAt','desc'));
  getDocs(qRef).then(snap=>{
    const all = snap.docs.map(d=>({id:d.id,...d.data()}));
    render(all);
  });
}));

resetFilters.onclick = ()=>{
  fromDateEl.value=''; toDateEl.value=''; byCatEl.value=''; qEl.value='';
  const user = auth.currentUser; if(!user) return;
  const ref = collection(db,'entries');
  const qRef = query(ref,where('uid','==',user.uid),orderBy('createdAt','desc'));
  getDocs(qRef).then(snap=>{
    const all = snap.docs.map(d=>({id:d.id,...d.data()}));
    render(all);
  });
};
</script>

<!-- jsPDF UMD -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script type="text/javascript">
const downloadPdfBtn = document.getElementById('downloadPdfBtn');
downloadPdfBtn.onclick = async ()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const user = firebase.auth?.currentUser || null;
  const ref = collection(db,'entries');
  const qRef = query(ref, where('uid','==',auth.currentUser.uid), orderBy('createdAt','desc'));
  const snap = await getDocs(qRef);
  const colorFilter = document.getElementById('pdfColorFilter').value;
  let y = 10;
  snap.docs.forEach(d=>{
    const e = d.data();
    if(colorFilter && e.color!==colorFilter) return;
    const date = e.createdAt?.toDate ? e.createdAt.toDate().toLocaleString() : '';
    doc.setFillColor(e.color==='yellow'?253,224,71:e.color==='green'?134,239,172:e.color==='blue'?147,197,253:233,213,255);
    doc.rect(10,y-2,190,10,'F');
    doc.setTextColor(0);
    doc.text(`${date} [${e.category}]`,10,y);
    y+=6;
    doc.text(e.text,10,y);
    y+=12;
    if(y>270){doc.addPage();y=10;}
  });
  doc.save('mi_diario_salud.pdf');
}
</script>

</body>
</html>
