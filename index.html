<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mi Diario Salud</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f6f7fb; margin:0; padding:0; }
    header { background:#4a90e2; color:white; padding:1rem; display:flex; justify-content:space-between; align-items:center; }
    header h1 { font-size:1.2rem; margin:0; }
    #user-info { display:flex; align-items:center; gap:8px; }
    #user-pic { border-radius:50%; width:32px; height:32px; } /* 游녣 tama침o avatar m치s peque침o */
    main { padding:1rem; }
    button { margin:4px; padding:8px 12px; border:none; border-radius:6px; background:#4a90e2; color:white; cursor:pointer; }
    button:hover { background:#357abd; }
    .note { border-radius:8px; padding:10px; margin:8px 0; }
    .yellow { background:#fef08a; }
    .green { background:#bbf7d0; }
    .blue { background:#bfdbfe; }
    .purple { background:#e9d5ff; }
    #filters { margin:1rem 0; padding:1rem; background:white; border-radius:8px; }
  </style>
</head>
<body>
  <header>
    <h1>Mi Diario Salud</h1>
    <div id="user-info">
      <img id="user-pic" src="" alt="User" hidden>
      <span id="user-name"></span>
      <button id="loginBtn">Iniciar sesi칩n</button>
      <button id="logoutBtn" style="display:none;">Cerrar sesi칩n</button>
    </div>
  </header>
  <main>
    <section id="filters">
      <h3>Filtros</h3>
      <label>Fecha: <input type="date" id="filterDate"></label>
      <label>Tipo: 
        <select id="filterCategory">
          <option value="">Todos</option>
          <option value="yellow">Men칰</option>
          <option value="green">Compra</option>
          <option value="blue">S칤ntomas</option>
          <option value="purple">Notas</option>
        </select>
      </label>
      <label>Texto: <input type="text" id="filterText"></label>
      <button id="applyFiltersBtn">Aplicar filtros</button>
    </section>

    <div>
      <button id="downloadTxtBtn">Descargar TXT</button>
      <button id="downloadPdfBtn">Descargar PDF</button>
    </div>

    <h3>Registros</h3>
    <div id="entries"></div>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>

  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    // === CONFIGURA TU FIREBASE ===
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "TU_PROJECT.firebaseapp.com",
      projectId: "TU_PROJECT",
      storageBucket: "TU_PROJECT.appspot.com",
      messagingSenderId: "XXX",
      appId: "XXX"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let currentEntries = []; // 游녣 almacenamos registros mostrados tras filtro

    // Login/Logout
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const userName = document.getElementById("user-name");
    const userPic = document.getElementById("user-pic");

    loginBtn.onclick = async () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      await auth.signInWithPopup(provider);
    };
    logoutBtn.onclick = () => auth.signOut();

    auth.onAuthStateChanged(user => {
      if(user){
        currentUser = user;
        userName.textContent = user.displayName;
        userPic.src = user.photoURL;
        userPic.hidden = false;
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        loadEntries();
      } else {
        currentUser = null;
        userName.textContent = "";
        userPic.hidden = true;
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        document.getElementById("entries").innerHTML = "";
      }
    });

    function renderEntries(entries){
      const container = document.getElementById("entries");
      container.innerHTML = "";
      entries.forEach(e => {
        const div = document.createElement("div");
        div.className = "note " + e.category;
        div.innerHTML = `<strong>${new Date(e.date.seconds*1000).toLocaleString()}</strong><br>${e.text}`;
        container.appendChild(div);
      });
      currentEntries = entries; // 游녣 guardamos lo mostrado
    }

    function loadEntries(){
      if(!currentUser) return;
      db.collection("entries").where("uid","==",currentUser.uid).orderBy("date","desc")
        .onSnapshot(snapshot => {
          const entries = snapshot.docs.map(doc => doc.data());
          renderEntries(entries);
        });
    }

    // Filtros
    document.getElementById("applyFiltersBtn").onclick = () => {
      if(!currentUser) return;
      let query = db.collection("entries").where("uid","==",currentUser.uid);

      const filterDate = document.getElementById("filterDate").value;
      if(filterDate){
        const start = new Date(filterDate);
        const end = new Date(filterDate);
        end.setDate(end.getDate()+1);
        query = query.where("date", ">=", start).where("date", "<", end);
      }
      const filterCategory = document.getElementById("filterCategory").value;
      if(filterCategory) query = query.where("category","==",filterCategory);

      query.orderBy("date","desc").get().then(snapshot => {
        let entries = snapshot.docs.map(doc => doc.data());
        const textFilter = document.getElementById("filterText").value.toLowerCase();
        if(textFilter) entries = entries.filter(e => e.text.toLowerCase().includes(textFilter));
        renderEntries(entries);
      });
    };

    // Descargar TXT
    document.getElementById("downloadTxtBtn").onclick = () => {
      if(currentEntries.length === 0){ alert("No hay registros para exportar"); return; }
      let text = currentEntries.map(e => `[${new Date(e.date.seconds*1000).toLocaleString()}] ${e.text}`).join("\n\n");
      const blob = new Blob([text], { type:"text/plain" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "mi_diario_salud.txt";
      link.click();
    };

    // Descargar PDF
    document.getElementById("downloadPdfBtn").onclick = () => {
      if(currentEntries.length === 0){ alert("No hay registros para exportar"); return; }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 20;
      doc.setFontSize(14);
      doc.text("Mi Diario Salud", 10, 10);
      currentEntries.forEach(e => {
        const d = new Date(e.date.seconds*1000);
        doc.setFontSize(11);
        doc.setFillColor(...colorHexToRGB(e.category));
        doc.rect(10, y-5, 190, 10, "F");
        doc.setTextColor(0,0,0);
        doc.text(`[${d.toLocaleString()}] ${e.text}`, 12, y+2);
        y += 15;
        if(y > 280){ doc.addPage(); y=20; }
      });
      doc.save("mi_diario_salud.pdf");
    };

    function colorHexToRGB(cat){
      switch(cat){
        case 'yellow': return [253,224,71];
        case 'green': return [134,239,172];
        case 'blue': return [147,197,253];
        case 'purple': return [233,213,255];
        default: return [200,200,200];
      }
    }
  </script>
</body>
</html>
